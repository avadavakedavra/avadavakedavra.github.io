<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Learning Portal â€” SEHR Academy</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --lime:#8BC53F;
  --bg:#f5f7f4;
  --dark:#1f2937;
  --border:#e5e7eb;
  --danger:#ef4444;
  --grey:#9ca3af;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Montserrat,sans-serif;
  background:var(--bg);
  color:var(--dark);
}

header{
  background:#fff;
  padding:30px 20px;
  text-align:center;
  border-bottom:1px solid var(--border);
}

header h1{
  margin:0;
  font-size:22px;
  font-weight:800;
}

header p{
  margin:8px 0 0;
  font-size:14px;
  color:var(--grey);
}

header::after{
  content:"";
  display:block;
  width:60px;
  height:3px;
  background:var(--lime);
  margin:12px auto 0;
  border-radius:2px;
}

.container{
  max-width:1100px;
  margin:40px auto;
  padding:0 20px;
}

.filter{
  margin-bottom:30px;
}

select{
  padding:10px 14px;
  border-radius:8px;
  border:1px solid var(--border);
  font-family:Montserrat;
  font-weight:600;
}

.section-title{
  font-weight:700;
  margin:30px 0 15px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:20px;
}

.card{
  background:#fff;
  border-radius:14px;
  box-shadow:0 4px 12px rgba(0,0,0,0.06);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

.thumb{
  width:100%;
  aspect-ratio:1/1;
  background-size:cover;
  background-position:center;
}

.card-body{
  padding:18px;
  flex:1;
  display:flex;
  flex-direction:column;
}

.subject{
  font-weight:700;
  margin-bottom:6px;
}

.topic{
  font-size:13px;
  opacity:0.7;
  margin-bottom:4px;
}

.teacher{
  font-size:12px;
  opacity:0.7;
  margin-bottom:8px;
}

.meta{
  font-size:12px;
  opacity:0.8;
  margin-bottom:6px;
}

.countdown{
  font-size:12px;
  font-weight:600;
  color:var(--lime);
  margin-bottom:8px;
}

.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 8px;
  font-size:11px;
  border-radius:6px;
  font-weight:700;
  margin-bottom:10px;
}

.live{
  background:var(--danger);
  color:#fff;
}

.upcoming{
  background:var(--lime);
  color:#fff;
}

.ended{
  background:#d1d5db;
  color:#111;
}

.live-dot{
  width:8px;
  height:8px;
  background:#fff;
  border-radius:50%;
  animation:blink 1s infinite;
}

@keyframes blink{
  0%{opacity:1;}
  50%{opacity:0.3;}
  100%{opacity:1;}
}

button{
  margin-top:auto;
  padding:10px;
  border:none;
  border-radius:8px;
  font-weight:700;
  cursor:pointer;
  background:var(--lime);
  color:#fff;
}

button:disabled{
  background:#ccc;
  cursor:not-allowed;
}
</style>
</head>

<body>

<header>
  <h1>Live Learning Portal</h1>
  <p>SEHR Academy</p>
</header>

<div class="container">

<div class="filter">
  <select id="classFilter">
    <option value="All">All Classes</option>
  </select>
</div>

<div id="liveSection"></div>
<div id="upcomingSection"></div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwYmCIYvjAI9ok41rJxNQWoFXw3SQP_tIk6nXVGyzMIDTy9c7Ajvvcjq-wHyavDtXBpQA/exec";

let allClasses = [];

async function fetchClasses(){
  const res = await fetch(API_URL);
  return await res.json();
}

function formatTime(date){
  return new Date(date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}

function getCountdown(start){
  const now = new Date();
  const diff = new Date(start) - now;

  if(diff <= 0) return "";

  const totalSeconds = Math.floor(diff / 1000);

  const days = Math.floor(totalSeconds / (3600 * 24));
  const hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;

  if(days > 0){
    return `Starts in ${days}d ${hours}h ${minutes}m`;
  }

  if(hours > 0){
    return `Starts in ${hours}h ${minutes}m`;
  }

  return `Starts in ${minutes}m ${seconds}s`;
}
function populateFilter(classes){
  const select = document.getElementById("classFilter");
  const unique = [...new Set(classes.map(c => c.className))];
  unique.forEach(cls=>{
    const option = document.createElement("option");
    option.value = cls;
    option.textContent = cls;
    select.appendChild(option);
  });
}

function render(){

  const now = new Date();
  const selectedClass = document.getElementById("classFilter").value;

  let filtered = selectedClass === "All"
    ? allClasses
    : allClasses.filter(c => c.className === selectedClass);

  filtered.sort((a,b)=>new Date(a.start)-new Date(b.start));

  const running = filtered.find(c => now >= new Date(c.start) && now <= new Date(c.end));

  let display = [];

  if(running){
    display.push(running);
    const upcoming = filtered.filter(c => new Date(c.start) > now);
    display = display.concat(upcoming.slice(0,2));
  }else{
    const upcoming = filtered.filter(c => new Date(c.start) > now);
    display = upcoming.slice(0,3);
  }

  const liveSection = document.getElementById("liveSection");
  const upcomingSection = document.getElementById("upcomingSection");

  liveSection.innerHTML = "";
  upcomingSection.innerHTML = "";

  if(display.length === 0){
    liveSection.innerHTML = "<div class='section-title'>No live sessions scheduled.</div>";
    return;
  }

  if(running){
    liveSection.innerHTML = "<div class='section-title'>ðŸ”´ Live Now</div>";
  }

  upcomingSection.innerHTML += "<div class='section-title'>Upcoming Classes</div>";

  const grid = document.createElement("div");
  grid.className = "grid";

  display.forEach(c=>{

    const start = new Date(c.start);
    const end = new Date(c.end);

    const joinWindowStart = new Date(start.getTime() - 10*60000);

    let statusClass="", badgeContent="", buttonText="", disabled=false;

    if(now < joinWindowStart){
      statusClass="upcoming";
      badgeContent="UPCOMING";
      buttonText="Not Available";
      disabled=true;
    }
    else if(now >= joinWindowStart && now <= end){
      if(now >= start){
        statusClass="live";
        badgeContent=`<span class="live-dot"></span> LIVE`;
      }else{
        statusClass="upcoming";
        badgeContent="STARTING SOON";
      }
      buttonText="Join Now";
    }
    else{
      statusClass="ended";
      badgeContent="ENDED";
      buttonText="Class Ended";
      disabled=true;
    }

    const card=document.createElement("div");
    card.className="card";

    card.innerHTML=`
      <div class="thumb" style="background-image:url('${c.thumbnail||''}')"></div>
      <div class="card-body">
        <div class="subject">${c.subject}</div>
        <div class="topic">${c.topic||''}</div>
        <div class="teacher">By ${c.teacher||'SEHR Faculty'}</div>
        <div class="meta">${c.className}</div>
        <div class="meta">${formatTime(start)} - ${formatTime(end)}</div>
        ${now < start ? `<div class="countdown">${getCountdown(start)}</div>`:''}
        <span class="badge ${statusClass}">${badgeContent}</span>
        <button ${disabled?'disabled':''}
          onclick="joinClass('${c.meetingLink}','${c.className}','${c.subject}')">
          ${buttonText}
        </button>
      </div>
    `;

    grid.appendChild(card);
  });

  upcomingSection.appendChild(grid);
}

function joinClass(link,className,subject){
  fetch(API_URL+"?action=logAttendance&class="+
    encodeURIComponent(className)+
    "&subject="+encodeURIComponent(subject));
  window.open(link,'_blank');
}

fetchClasses().then(classes=>{
  allClasses=classes;
  populateFilter(classes);
  render();
  document.getElementById("classFilter").addEventListener("change",render);
  setInterval(render,1000);
});
</script>

</body>
</html>
