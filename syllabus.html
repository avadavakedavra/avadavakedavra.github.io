<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sehr Academy — Class 11 Syllabus (Live from Google Sheets)</title>
  <meta name="theme-color" content="#8BC53F" />
  <meta name="description" content="Class 11 syllabus completion tracker for Physics, Chemistry, Mathematics, Biology — filter by status, search by chapter or teacher, live dates." />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800;900&family=Nunito:wght@400;700;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --sehr-green:#8BC53F;
      --ink:#0F172A;
      --glass-border: rgba(0,0,0,.08);
      --radius: 16px;
      --maxw:1180px;
      --frost-white: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.70));
      --frost-green: linear-gradient(180deg, rgba(214, 244, 190, .95), rgba(180, 232, 140, .78));
      --crystal: linear-gradient(180deg, rgba(255,255,255,.66), rgba(255,255,255,.30));
      --bar-gold: linear-gradient(90deg, #FBE7A1 0%, #F5C14A 50%, #D89A00 100%);
      --hint-bg: linear-gradient(180deg,#ffffff,#f5f7fb);
      --pill-bg: linear-gradient(180deg,#ffffff, rgba(255,255,255,.82));
    }
    *{box-sizing:border-box}
    html,body{margin:0}
    body{
      font-family: Nunito, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
      background: linear-gradient(180deg, #ffffff 0%, #fbfcfd 50%, #f7f8fa 100%);
      color:#111; line-height:1.65; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* Header */
    .container{max-width:var(--maxw);margin:0 auto;padding:0 20px}
    .pagehead{max-width:var(--maxw);margin:22px auto 10px;padding:0 20px;display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .title{font-family:Montserrat;font-weight:900;font-size:26px;letter-spacing:.2px}
    .subtitle{color:#6b7280;font-weight:800}
    .stamp{font-family:Montserrat;font-weight:800;font-size:12px;color:#2b3345;opacity:.85}

    /* Controls */
    .controls{max-width:var(--maxw);margin:6px auto 0;padding:0 20px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--glass-border); background:linear-gradient(180deg,#fff,rgba(255,255,255,.85));font-weight:800; cursor:pointer; user-select:none}
    .chip:hover{filter:brightness(1.03)}
    .chip[aria-pressed="true"]{outline:2px solid rgba(139,197,63,.45); box-shadow:0 6px 16px rgba(139,197,63,.18)}
    .search{flex:1; min-width:240px; display:flex; align-items:center; gap:8px; background:var(--hint-bg); border:1px solid var(--glass-border); border-radius:12px; padding:8px 12px}
    .search input{border:0;background:transparent;outline:none;flex:1;font-weight:800}

    /* Legend panel */
    .panel{max-width:var(--maxw); margin:10px auto 0; padding:16px 20px; border-radius:var(--radius);
      border:1px solid var(--glass-border); background:var(--frost-white); box-shadow:0 20px 45px rgba(15,23,42,.10);}
    .legend{display:flex;gap:12px;flex-wrap:wrap;font-weight:800;color:#334}
    .dot{width:10px;height:10px;border-radius:999px;background:#cfd6df}
    .dot.pending{background:#cfd6df}
    .dot.ongoing{background:#f6c761}
    .dot.completed{background:#69c04c}

    /* Subject accordions */
    details.group{max-width:var(--maxw); margin:14px auto; border-radius:16px; border:1px solid var(--glass-border);
      background:var(--frost-white); box-shadow:0 20px 45px rgba(15,23,42,.10); overflow:hidden}
    details.group > summary{
      list-style:none; cursor:pointer; padding:16px 18px; user-select:none; display:grid;
      grid-template-columns: 1fr auto; align-items:center; gap:10px;
      font-family:Montserrat; font-weight:900; font-size:18px;
      background:linear-gradient(180deg,#ffffff, #f2f6f1);
      border-bottom:1px solid rgba(230,232,236,.6);
    }
    details.group > summary::-webkit-details-marker{display:none}
    .sum-left{display:flex;align-items:center;gap:12px}
    .subject-name{font-size:18px; color:#0b0f10; text-transform:uppercase; letter-spacing:.4px}
    .sum-right{display:flex; align-items:center; gap:14px}

    /* Progress mini bar */
    .prog-wrap{width:220px; display:flex; flex-direction:column; gap:4px}
    .prog-rail{width:100%; height:8px; border-radius:999px; background:rgba(0,0,0,.06); position:relative; overflow:hidden; border:1px solid rgba(0,0,0,.06)}
    .prog-fill{height:100%; width:0%; background:var(--bar-gold); border-radius:999px; transition:width .45s ease}
    .prog-note{font-size:10px; font-weight:900; color:#2b3345; text-transform:uppercase; letter-spacing:.4px; opacity:.8; text-align:right}

    /* Chapters */
    .chapters{padding:8px 16px 18px 16px; display:grid; gap:10px}
    .row{
      display:grid; grid-template-columns: 1fr auto auto auto; gap:12px; align-items:center;
      padding:14px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.55);
      background:var(--crystal);
      backdrop-filter: blur(9px) saturate(160%);
      -webkit-backdrop-filter: blur(9px) saturate(160%);
      box-shadow:0 10px 28px rgba(15,23,42,.10), inset 0 1px 0 rgba(255,255,255,.45);
      transition:transform .18s ease, box-shadow .18s ease, filter .18s ease, border-color .18s ease;
    }
    .row:hover{
      transform:translateY(-2px);
      box-shadow:0 16px 36px rgba(15,23,42,.14), inset 0 1px 0 rgba(255,255,255,.55);
      border-color:rgba(255,255,255,.75);
      filter:drop-shadow(0 0 6px rgba(139,197,63,.18));
    }
    .row.completed{
      background: var(--frost-green);
      border-color: rgba(139,197,63,.55);
      box-shadow:0 12px 30px rgba(139,197,63,.18), inset 0 1px 0 rgba(255,255,255,.6);
    }
    .row .name{font-weight:800}

    /* Pills */
    .status, .teacher, .date{
      font-family:Montserrat; font-weight:900; font-size:12px; padding:6px 8px;
      border-radius:8px; border:1px solid var(--glass-border);
      min-width:96px; text-align:center; letter-spacing:.3px;
      background:var(--pill-bg); color:#334;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .status{ text-transform:uppercase; }
    .status.ongoing{background:linear-gradient(180deg,#fff7e6,#fff4d6)}
    .status.completed{background:linear-gradient(180deg,#e8fadf,#d9f7c7); color:#0a5a1a; border-color:rgba(139,197,63,.55)}
    .teacher{max-width:220px}
    .date{ color:#2b3345 }
    .date:empty{ display:none }

    /* Mobile */
    @media (max-width: 640px){
      .row{grid-template-columns: 1fr; align-items:start}
      .status, .teacher, .date{justify-self:start; min-width:unset}
    }
  </style>
</head>
<body>
  <div class="pagehead">
    <div>
      <div class="title">Class 11 Syllabus — Completion Tracker</div>
      <div class="subtitle">Filter by status, search by chapter or teacher. Data live from Google Sheets.</div>
      <div class="stamp" id="last-updated"></div>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <div id="filters" role="tablist" aria-label="Filter chapters by status">
      <button data-filter="all" class="chip" aria-pressed="true">All</button>
      <button data-filter="pending" class="chip" aria-pressed="false">Pending</button>
      <button data-filter="ongoing" class="chip" aria-pressed="false">Ongoing</button>
      <button data-filter="completed" class="chip" aria-pressed="false">Completed</button>
    </div>

    <button id="btn-collapse-all" class="chip" type="button" title="Collapse all subjects">Collapse All</button>

    <div class="search" role="search" title="Type to search chapter titles or teacher names">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.2-4.2M10.8 18a7.2 7.2 0 1 1 0-14.4 7.2 7.2 0 0 1 0 14.4Z" stroke="#2b3345" stroke-width="2" stroke-linecap="round"/></svg>
      <input id="search" type="search" placeholder="Search chapters or teachers…" aria-label="Search chapters by name or teacher" />
    </div>
  </div>

  <!-- Legend -->
  <section class="panel" aria-label="Legend">
    <div class="legend">
      <span class="chip"><span class="dot pending"></span> Pending</span>
      <span class="chip"><span class="dot ongoing"></span> Ongoing</span>
      <span class="chip"><span class="dot completed"></span> Completed</span>
    </div>
  </section>

  <!-- Subjects -->
  <details class="group" data-subject="physics">
    <summary>
      <span class="sum-left"><span class="subject-name">Physics</span></span>
      <span class="sum-right">
        <span class="prog-wrap">
          <span class="prog-rail"><span class="prog-fill" id="bar-physics"></span></span>
          <span class="prog-note" id="note-physics">0/0</span>
        </span>
        <span class="chip">Click to toggle</span>
      </span>
    </summary>
    <div class="chapters" id="list-physics"></div>
  </details>

  <details class="group" data-subject="chemistry">
    <summary>
      <span class="sum-left"><span class="subject-name">Chemistry</span></span>
      <span class="sum-right">
        <span class="prog-wrap">
          <span class="prog-rail"><span class="prog-fill" id="bar-chemistry"></span></span>
          <span class="prog-note" id="note-chemistry">0/0</span>
        </span>
        <span class="chip">Click to toggle</span>
      </span>
    </summary>
    <div class="chapters" id="list-chemistry"></div>
  </details>

  <details class="group" data-subject="mathematics">
    <summary>
      <span class="sum-left"><span class="subject-name">Mathematics</span></span>
      <span class="sum-right">
        <span class="prog-wrap">
          <span class="prog-rail"><span class="prog-fill" id="bar-mathematics"></span></span>
          <span class="prog-note" id="note-mathematics">0/0</span>
        </span>
        <span class="chip">Click to toggle</span>
      </span>
    </summary>
    <div class="chapters" id="list-mathematics"></div>
  </details>

  <details class="group" data-subject="botany">
    <summary>
      <span class="sum-left"><span class="subject-name">Biology — Botany</span></span>
      <span class="sum-right">
        <span class="prog-wrap">
          <span class="prog-rail"><span class="prog-fill" id="bar-botany"></span></span>
          <span class="prog-note" id="note-botany">0/0</span>
        </span>
        <span class="chip">Click to toggle</span>
      </span>
    </summary>
    <div class="chapters" id="list-botany"></div>
  </details>

  <details class="group" data-subject="zoology">
    <summary>
      <span class="sum-left"><span class="subject-name">Biology — Zoology</span></span>
      <span class="sum-right">
        <span class="prog-wrap">
          <span class="prog-rail"><span class="prog-fill" id="bar-zoology"></span></span>
          <span class="prog-note" id="note-zoology">0/0</span>
        </span>
        <span class="chip">Click to toggle</span>
      </span>
    </summary>
    <div class="chapters" id="list-zoology"></div>
  </details>

  <script>
    /* =================== CONFIG: Google Sheets (GViz) =================== */
    const SHEET_ID   = "1JZ2b4tFp9xqHsauaqti2GtoiWaSLkERPIorJ2n7yAjo";
    const SHEET_NAME = "Sheet1";
    const GVIZ_URL   = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

    // Optional local fallback JSON
    const CANDIDATES = [
      new URL('./data/syllabus.json?cb=' + Date.now(), location.href).toString(),
      new URL('data/syllabus.json?cb=' + Date.now(), location.href).toString(),
      location.origin + '/data/syllabus.json?cb=' + Date.now()
    ];
    async function fetchFirst(paths){
      for(const p of paths){
        try{
          const r = await fetch(p, {cache:'no-store'});
          if(r.ok) return { res: r, url: p };
        }catch(e){}
      }
      throw new Error('No local fallback JSON was found.');
    }

    /* =================== Refs =================== */
    const lists = {
      physics: document.getElementById('list-physics'),
      chemistry: document.getElementById('list-chemistry'),
      mathematics: document.getElementById('list-mathematics'),
      botany: document.getElementById('list-botany'),
      zoology: document.getElementById('list-zoology')
    };
    const bars = {
      physics: document.getElementById('bar-physics'),
      chemistry: document.getElementById('bar-chemistry'),
      mathematics: document.getElementById('bar-mathematics'),
      botany: document.getElementById('bar-botany'),
      zoology: document.getElementById('bar-zoology')
    };
    const notes = {
      physics: document.getElementById('note-physics'),
      chemistry: document.getElementById('note-chemistry'),
      mathematics: document.getElementById('note-mathematics'),
      botany: document.getElementById('note-botany'),
      zoology: document.getElementById('note-zoology')
    };
    const lastUpdatedEl = document.getElementById('last-updated');

    /* =================== Utilities =================== */
    function fmtDayMonth(s){
      if(!s) return '';
      const d = new Date(s);
      if(isNaN(d)) return '';
      const day = d.getDate().toString().padStart(2,'0');
      const mon = d.toLocaleString('en-GB',{month:'short'});
      return `${day} ${mon}`;
    }

    function formatTeachers(item){
      // Accept either `teacher: "Name"` or `teachers: ["A", "B"]`
      let t = '';
      if (Array.isArray(item.teachers)) {
        t = item.teachers.filter(Boolean).join(', ');
      } else if (typeof item.teacher === 'string') {
        t = item.teacher.trim();
      } else if (typeof item.teachers === 'string') {
        t = item.teachers.trim();
      }
      return t || '—';
    }

    function makeRow(item){
      const div = document.createElement('div');
      const st = (item.status || 'pending').toLowerCase();
      const when = fmtDayMonth(item.expectedDate || '');
      const teachers = formatTeachers(item);

      div.className = 'row ' + (st==='completed' ? 'completed' : '');
      div.dataset.status = st;
      div.dataset.name = (item.title || '').toLowerCase();
      div.dataset.teachers = teachers.toLowerCase();

      const dateHTML = when ? `<div class="date" title="${when}">${when}</div>` : `<div class="date"></div>`;
      const teacherHTML = `<div class="teacher" title="${teachers}">${teachers}</div>`;

      div.innerHTML = `
        <div class="name">${item.index ? (item.index + '. ') : ''}${item.title}</div>
        <div class="status ${st}">${st.toUpperCase()}</div>
        ${teacherHTML}
        ${dateHTML}
      `;
      return div;
    }

    function setProgress(total, done, key){
      const bar = bars[key];
      const note = notes[key];
      if(!bar || !note) return;
      const pct = total ? Math.round((done/total)*100) : 0;
      bar.style.width = '0%';
      requestAnimationFrame(()=>{ bar.style.width = pct + '%'; });
      note.textContent = `${done}/${total}`;
    }

    function renderSimple(arr, mount, key){
      mount.innerHTML = '';
      const sorted = [...arr].sort((a,b)=>(a.index||999)-(b.index||999));
      let done = 0;
      sorted.forEach(ch => {
        if((ch.status||'').toLowerCase()==='completed') done++;
        mount.appendChild(makeRow(ch));
      });
      setProgress(sorted.length, done, key);
    }

    function renderBioStreams(bio){
      const botany = (bio || []).filter(x => (x.stream||'').toLowerCase()==='botany');
      const zoology = (bio || []).filter(x => (x.stream||'').toLowerCase()==='zoology');

      lists.botany.innerHTML = '';
      let doneB=0;
      botany.sort((a,b)=>(a.index||999)-(b.index||999)).forEach(ch=>{
        if((ch.status||'').toLowerCase()==='completed') doneB++;
        lists.botany.appendChild(makeRow(ch));
      });
      setProgress(botany.length, doneB, 'botany');

      lists.zoology.innerHTML = '';
      let doneZ=0;
      zoology.sort((a,b)=>(a.index||999)-(b.index||999')).forEach(ch=>{
        if((ch.status||'').toLowerCase()==='completed') doneZ++;
        lists.zoology.appendChild(makeRow(ch));
      });
      setProgress(zoology.length, doneZ, 'zoology');
    }

    /* =================== Filters & Search =================== */
    const filterState = { value:'all', query:'' };

    function applyFilters(){
      const rows = document.querySelectorAll('.chapters .row');
      rows.forEach(r=>{
        const st = r.dataset.status;
        const name = r.dataset.name || '';
        const teachers = r.dataset.teachers || '';
        const statusMatch = (filterState.value==='all' || st===filterState.value);
        const q = (filterState.query || '');
        const textMatch = (!q || name.includes(q) || teachers.includes(q));
        r.style.display = (statusMatch && textMatch) ? '' : 'none';
      });
    }

    document.getElementById('filters').addEventListener('click', e=>{
      if(e.target.matches('button[data-filter]')){
        filterState.value = e.target.dataset.filter;
        [...e.currentTarget.querySelectorAll('button')].forEach(b=>b.setAttribute('aria-pressed', String(b===e.target)));
        applyFilters();
      }
    });

    document.getElementById('search').addEventListener('input', e=>{
      filterState.query = (e.target.value || '').toLowerCase().trim();
      applyFilters();
    });

    document.getElementById('btn-collapse-all').addEventListener('click', ()=>{
      document.querySelectorAll('details.group[open]').forEach(d=> d.open = false);
    });

    /* =================== Google Sheets (GViz) Loader =================== */
    async function fetchGViz() {
      const r = await fetch(GVIZ_URL, { cache: "no-store" });
      const txt = await r.text();
      const m = txt.match(/google\.visualization\.Query\.setResponse\(([\s\S]+)\);/);
      if (!m) throw new Error("GViz: unexpected response");
      return JSON.parse(m[1]);
    }

    function gvizTableToObjects(gviz) {
      const cols = gviz.table.cols.map(c => (c.label || "").trim());
      return gviz.table.rows.map(row => {
        const obj = {};
        (row.c || []).forEach((cell, i) => {
          obj[cols[i]] = cell ? cell.v : "";
        });
        return obj;
      });
    }

    function normalizeRow(row) {
      const subject = String(row.Subject || "").trim().toLowerCase();
      const stream  = String(row.Stream  || "").trim().toLowerCase();
      const teachersList = String(row["Teacher(s)"] || "").split(",").map(s => s.trim()).filter(Boolean);

      const it = {
        index: Number(row.Index) || undefined,
        title: String(row.Title || "").trim(),
        status: String(row.Status || "pending").trim().toLowerCase(),
        expectedDate: row.ExpectedDate ? String(row.ExpectedDate).slice(0,10) : "",
      };

      // Teacher(s)
      if (teachersList.length > 1) it.teachers = teachersList;
      else if (teachersList.length === 1) it.teacher = teachersList[0];
      else if (row.Teacher) it.teacher = String(row.Teacher).trim();

      // Biology streams
      if (subject === "biology" || subject === "botany" || subject === "zoology") {
        it.stream = stream || (subject !== "biology" ? subject : "");
        return { bucket: "biology", item: it };
      }
      return { bucket: subject, item: it };
    }

    async function loadFromGoogleSheets() {
      const gviz = await fetchGViz();
      const rows = gvizTableToObjects(gviz);

      const data = {
        meta: { lastUpdated: new Date().toISOString() },
        physics: [], chemistry: [], mathematics: [], biology: []
      };

      rows.forEach(r => {
        const { bucket, item } = normalizeRow(r);
        if (!bucket) return;
        if (bucket === "physics" || bucket === "chemistry" || bucket === "mathematics") {
          data[bucket].push(item);
        } else if (bucket === "biology") {
          data.biology.push(item);
        }
      });

      return data;
    }

    /* =================== Init (Sheets first, then fallback) =================== */
    async function init(){
      try{
        // Primary: Google Sheets
        const data = await loadFromGoogleSheets();

        if (lastUpdatedEl && data.meta?.lastUpdated){
          const d = new Date(data.meta.lastUpdated);
          if (!isNaN(d)){
            lastUpdatedEl.textContent = 'Last updated: ' + d.toLocaleString('en-IN', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
          }
        }

        renderSimple(data.physics || [], lists.physics, 'physics');
        renderSimple(data.chemistry || [], lists.chemistry, 'chemistry');
        renderSimple(data.mathematics || [], lists.mathematics, 'mathematics');
        renderBioStreams(data.biology || []);

      }catch(err){
        console.warn('Sheets load failed, trying local /data/syllabus.json', err);
        try{
          const { res } = await fetchFirst(CANDIDATES);
          const data = await res.json();

          if (data.meta && data.meta.lastUpdated){
            const d = new Date(data.meta.lastUpdated);
            if (!isNaN(d)){
              lastUpdatedEl.textContent = 'Last updated: ' + d.toLocaleString('en-IN', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
            }
          }

          renderSimple(data.physics || [], lists.physics, 'physics');
          renderSimple(data.chemistry || [], lists.chemistry, 'chemistry');
          renderSimple(data.mathematics || [], lists.mathematics, 'mathematics');
          renderBioStreams(data.biology || []);
        }catch(e){
          console.error('Failed to load fallback JSON', e);
          Object.values(lists).forEach(m=>{
            const d = document.createElement('div');
            d.className='row';
            d.innerHTML = '<div class="name">Couldn’t load data (Sheets & JSON failed).</div><div class="status">ERROR</div><div class="teacher">—</div><div class="date"></div>';
            m.appendChild(d);
          });
        }
      } finally {
        // Close all groups by default and apply filters once rendered
        document.querySelectorAll('details.group').forEach(d => d.open = false);
        applyFilters();
      }
    }
    init();
  </script>
</body>
</html>
