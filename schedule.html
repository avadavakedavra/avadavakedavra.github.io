<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sehr Academy â€” Test & Events Schedule</title>
<meta name="description" content="Sehr Academy schedule auto-updated from Google Sheets.">
<meta name="theme-color" content="#8BC53F" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --primary:#8BC53F; --text:#0f172a; --muted:#64748b; --bg:#edf3e7; --border:rgba(255,255,255,.55); --maxw:1180px; }
  *{box-sizing:border-box} html,body{margin:0}
  body{
    font-family:Nunito,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:var(--bg);line-height:1.65;
    background-image:
      radial-gradient(1000px 500px at -10% -10%, rgba(165, 230, 80, .08), transparent),
      radial-gradient(900px 600px at 110% 0%, rgba(120, 179, 56, .06), transparent);
    background-attachment: fixed, fixed;
  }
  header{position:sticky;top:0;z-index:40;background:rgba(255,255,255,.78);border-bottom:1px solid rgba(230,232,236,.6);backdrop-filter:saturate(175%) blur(10px)}
  .container{max-width:var(--maxw);margin:0 auto;padding:0 20px}
  .nav{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
  .brand{display:flex;gap:8px;text-decoration:none}
  .brand span:nth-child(1){font-family:Montserrat;font-weight:800;font-size:26px;color:var(--primary)}
  .brand span:nth-child(2){font-family:Montserrat;font-weight:800;font-size:26px;color:#0b0f10}
  nav[aria-label="Primary"] a{font-family:Montserrat;color:#0b0f10;text-decoration:none;margin-left:16px;font-weight:700;font-size:14px;position:relative}
  nav[aria-label="Primary"] a:after{content:"";position:absolute;left:0;bottom:-6px;width:0;height:2px;background:var(--primary);transition:width .2s}
  nav[aria-label="Primary"] a:hover{color:var(--primary)} nav[aria-label="Primary"] a:hover:after{width:100%}

  main section{padding:72px 0}
  .glass{background:linear-gradient(180deg,rgba(255,255,255,.55),rgba(255,255,255,.32));border:1px solid var(--border);border-radius:16px;backdrop-filter: blur(12px) saturate(150%);box-shadow:0 20px 50px rgba(16,24,40,.08)}
  h1,h2{font-family:Montserrat;margin:0} h1{font-size:40px}
  .muted{color:var(--muted);font-weight:700}
  .card{padding:20px}

  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;font-weight:800;cursor:pointer;border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.7))}
  .chip[aria-pressed="true"]{ outline:3px solid #e0f2c8 }
  .search{flex:1;min-width:220px}
  .search input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);font-weight:800;background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.7))}

  /* Timeline */
  .timeline{position:relative;margin-top:18px}
  .tl-month{position:sticky;top:64px;z-index:5;margin:24px 0 10px;display:inline-block;padding:8px 12px;border-radius:10px;font-weight:900;background:#eef8df;border:1px solid #e0f2c8}
  .tl-list{position:relative}.tl-line{position:absolute;left:18px;top:0;bottom:0;width:2px;background:#dfe8cf}
  .tl-item{position:relative;padding-left:56px;margin:14px 0}
  .tl-dot{position:absolute;left:10px;top:20px;width:16px;height:16px;border-radius:50%;background:#fff;border:3px solid var(--primary);box-shadow:0 0 0 4px rgba(139,197,63,.15)}
  .event{border:1px solid var(--border);border-radius:14px;background:linear-gradient(180deg,#fff,#f7fbf1)}
  .event-head{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .date-pill{font-family:Montserrat;font-weight:900;background:#fff;border:1px solid #eaeef0;border-radius:10px;padding:6px 10px}
  .title{font-family:Montserrat;font-weight:800}.meta{color:var(--muted);font-weight:800}.note{margin-top:8px}
  .today .event{border-color:#cfe9b1;box-shadow:0 8px 20px rgba(139,197,63,.18), inset 0 1px 0 #fff}
  .past .event{opacity:.75}

  /* Skeleton + states */
  .skeleton{animation:pulse 1.2s ease-in-out infinite;background:linear-gradient(90deg,#f0f3ee,#f7faf5,#f0f3ee);background-size:200% 100%}
  @keyframes pulse{0%{background-position:0 0}100%{background-position:200% 0}}
  .sk-item{height:84px;border-radius:14px;margin:12px 0}
  .empty{padding:16px;border-radius:14px;background:linear-gradient(180deg,#fff,#fafafa);border:1px dashed #e2e8f0;text-align:center;font-weight:900;color:#6b7280}
  .error{border-color:#fecaca;background:#fff5f5;color:#b91c1c}
</style>
</head>
<body>
<header role="banner">
  <div class="container nav">
    <a class="brand" href="https://sehracademy.com" aria-label="Sehr Academy"><span>SEHR</span><span>ACADEMY</span></a>
    <nav aria-label="Primary">
      <a href="https://sehracademy.com/#features">Features</a>
      <a href="https://sehracademy.com/#programs">Programs</a>
      <a href="https://sehracademy.com/studentlogin">Student Login</a>
      <a href="#contact">Contact</a>
    </nav>
  </div>
</header>

<main>
  <section>
    <div class="container">
      <div class="glass card">
        <h1>ðŸ“… Test & Events Schedule</h1>
        <div class="muted" style="margin-top:6px">Auto-updates from Google Sheets. Use filters or search.</div>
        <div class="controls">
          <button id="toggle-upcoming" class="chip" type="button" aria-pressed="true">Upcoming</button>
          <button id="toggle-past" class="chip" type="button" aria-pressed="false">Past</button>
          <div id="class-chips" class="controls"></div>
          <div class="search"><input id="search" type="search" placeholder="Search title or notesâ€¦" aria-label="Search"></div>
        </div>
      </div>

      <!-- Skeleton -->
      <div id="skeleton" style="margin-top:16px">
        <div class="sk-item skeleton"></div><div class="sk-item skeleton"></div><div class="sk-item skeleton"></div>
      </div>

      <div id="timeline" class="timeline" hidden></div>
      <div id="empty" class="empty" hidden>No items match your filters.</div>
      <div id="error" class="empty error" hidden>
        Couldnâ€™t load the schedule.<br>
        <small>Last URL tried: <a id="err-url" href="#" target="_blank" rel="noopener">open link</a></small>
      </div>
    </div>
  </section>
</main>

<section id="contact" style="padding:40px 0 80px;">
  <div class="container"><div class="muted" style="text-align:center;font-weight:800">WhatsApp: <a href="https://wa.me/919539409586" target="_blank" rel="noopener" style="font-weight:900">+91 95394 09586</a></div></div>
</section>

<script>
(function(){
  // ==== Your published doc + fixed gid=0 ====
  const PUB_BASE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSAnsnHnS4iGoFWAjwL8U6l2PAus6QSm8lV9-9FfLjVm7U5j1PiC7qShzDbtB-IyltQSgEeO5Q5aa3v";
  const GID = 0;

  // Endpoints
  const CSV_URL  = `${PUB_BASE}/pub?gid=${GID}&single=true&output=csv`;
  const JSON_URL = `${PUB_BASE}/gviz/tq?tqx=out:json&gid=${GID}`;

  // DOM
  const $timeline = document.getElementById('timeline');
  const $skeleton = document.getElementById('skeleton');
  const $error = document.getElementById('error');
  const $errUrl = document.getElementById('err-url');
  const $empty = document.getElementById('empty');
  const $classChips = document.getElementById('class-chips');
  const $search = document.getElementById('search');
  const $tglUpcoming = document.getElementById('toggle-upcoming');
  const $tglPast = document.getElementById('toggle-past');

  let rawItems = [];
  let activeClasses = new Set();
  let show = 'upcoming';
  let searchText = '';

  // Load: CSV first, then GViz
  (async function init(){
    try{
      let items;
      try{
        items = await fetchCSV(CSV_URL);
        if(!items.length) throw new Error('CSV empty');
      }catch(_){
        items = await fetchGViz(JSON_URL);
      }
      if(!items.length) throw new Error('No rows');
      // Normalize to YYYY-MM-DD
      rawItems = items.map(x=>{
        const dt = parseLocalISO(x.date); if(!dt) return x;
        const iso = [dt.getFullYear(), String(dt.getMonth()+1).padStart(2,'0'), String(dt.getDate()).padStart(2,'0')].join('-');
        return {...x, date: iso};
      });
      renderFilters(rawItems);
      $skeleton.hidden = true;
      $timeline.hidden = false;
      draw();
    }catch(e){
      console.error(e);
      $skeleton.hidden = true;
      $error.hidden = false;
      $errUrl.href = (e && e.url) ? e.url : CSV_URL;
      $errUrl.textContent = (e && e.url) ? e.url : CSV_URL;
    }
  })();

  // CSV (robust parser)
  async function fetchCSV(url){
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw {message:'CSV HTTP '+res.status, url};
    const text = await res.text();
    if(!text.trim()) return [];
    const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
    const headers = parseCsvLine(lines[0]);
    const iDate  = findCol(headers, ['Date','date']);
    const iTitle = findCol(headers, ['Event Title','Title','title','Event']);
    const iCls   = findCol(headers, ['Class','Batch','class','batch']);
    const iNotes = findCol(headers, ['Notes','Note','Remarks','notes','remark']);
    return lines.slice(1).map(row=>{
      const arr = parseCsvLine(row);
      const pick = (i)=> (i>=0 && arr[i]!=null ? arr[i] : '').trim();
      return { date: pick(iDate), title: pick(iTitle), cls: pick(iCls), notes: pick(iNotes) };
    }).filter(x => x.date && x.title);
  }
  function parseCsvLine(line){
    const out=[]; let cur=''; let q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else { q=!q; } }
      else if(ch===',' && !q){ out.push(cur); cur=''; }
      else { cur+=ch; }
    }
    out.push(cur);
    return out.map(s=>s.replace(/^\s*"(.*)"\s*$/,'$1'));
  }

  // GViz JSON
  async function fetchGViz(url){
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw {message:'GViz HTTP '+res.status, url};
    const text = await res.text();
    const first = text.indexOf('{'), last = text.lastIndexOf('}');
    if(first === -1 || last === -1) return [];
    const json = JSON.parse(text.slice(first, last+1));
    if(!json.table || !json.table.rows) return [];
    const cols = (json.table.cols||[]).map(c => (c.label || '').trim());
    const rows = (json.table.rows||[]).map(r => r.c.map(c => c ? c.v : ''));
    const idx = {
      date:  findCol(cols, ['Date','date','DATE']),
      title: findCol(cols, ['Event Title','Title','title','EVENT']),
      cls:   findCol(cols, ['Class','Batch','class','batch']),
      notes: findCol(cols, ['Notes','Note','Remarks','notes','remark']),
    };
    return rows.map(a=>({
      date: (a[idx.date]||'').toString().trim(),
      title:(a[idx.title]||'').toString().trim(),
      cls:  (a[idx.cls]||'').toString().trim(),
      notes:(a[idx.notes]||'').toString().trim(),
    })).filter(x=>x.date && x.title);
  }

  function findCol(cols, names){
    if(!cols || !cols.length) return -1;
    for(const n of names){
      const i = cols.findIndex(c => c.toLowerCase() === n.toLowerCase());
      if(i !== -1) return i;
    }
    return -1;
  }

  // Date helpers
  function parseLocalISO(d){
    d = (d||'').trim();
    let dt;
    if(/^\d{4}-\d{1,2}-\d{1,2}$/.test(d)){ const [y,m,dd]=d.split('-').map(Number); dt=new Date(y,m-1,dd); }
    else if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(d)){ const [dd,m,y]=d.split('/').map(Number); dt=new Date(y,m-1,dd); }
    else { const t=new Date(d); dt=isNaN(t)?null:new Date(t.getFullYear(),t.getMonth(),t.getDate()); }
    return dt;
  }
  function isToday(dt){ const n=new Date(); return dt && dt.getFullYear()===n.getFullYear() && dt.getMonth()===n.getMonth() && dt.getDate()===n.getDate(); }
  function formatDate(dt){ return dt.toLocaleDateString(undefined,{weekday:'short', year:'numeric', month:'short', day:'numeric'}); }
  function monthKey(dt){ return dt.getFullYear() + '-' + String(dt.getMonth()+1).padStart(2,'0'); }
  function monthLabel(dt){ return dt.toLocaleDateString(undefined,{month:'long', year:'numeric'}); }
  function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function renderFilters(items){
    const classes = Array.from(new Set(items.map(x => x.cls).filter(Boolean))).sort();
    $classChips.innerHTML = '';
    if(!classes.length) return;
    const label = document.createElement('div'); label.className='muted'; label.style.fontWeight='800'; label.textContent='Filter:'; $classChips.appendChild(label);
    classes.forEach(cls=>{
      const chip = document.createElement('button'); chip.className='chip'; chip.type='button'; chip.setAttribute('aria-pressed','false'); chip.textContent=cls;
      chip.addEventListener('click', ()=>{
        if(activeClasses.has(cls)) activeClasses.delete(cls); else activeClasses.add(cls);
        chip.setAttribute('aria-pressed', activeClasses.has(cls) ? 'true' : 'false');
        draw();
      });
      $classChips.appendChild(chip);
    });
  }

  function applyFilters(items){
    const now = new Date(); const today0 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    return items.filter(it=>{
      const dt = parseLocalISO(it.date); if(!dt) return false;
      if(show==='upcoming' && dt < today0) return false;
      if(show==='past' && dt >= today0) return false;
      if(activeClasses.size && !activeClasses.has(it.cls)) return false;
      if(searchText){
        const q = searchText.toLowerCase();
        if(!(it.title.toLowerCase().includes(q) || (it.notes||'').toLowerCase().includes(q))) return false;
      }
      return true;
    });
  }

  function draw(){
    const items = applyFilters(rawItems).sort((a,b)=> parseLocalISO(a.date) - parseLocalISO(b.date));
    $timeline.innerHTML = '';
    if(!items.length){ $timeline.hidden = true; $empty.hidden = false; return; }
    $timeline.hidden = false; $empty.hidden = true;

    const listWrap = document.createElement('div'); listWrap.className='tl-list';
    const line = document.createElement('div'); line.className='tl-line'; listWrap.appendChild(line);

    let mk = '';
    items.forEach(it=>{
      const dt = parseLocalISO(it.date); const thisMk = monthKey(dt);
      if(thisMk !== mk){ mk = thisMk; const m = document.createElement('div'); m.className='tl-month'; m.textContent = monthLabel(dt); $timeline.appendChild(m); $timeline.appendChild(listWrap); }
      const li = document.createElement('div'); li.className = 'tl-item ' + (isToday(dt) ? 'today' : (dt < new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate()) ? 'past' : ''));
      li.innerHTML = `<div class="tl-dot"></div>
        <div class="event card">
          <div class="event-head">
            <div class="date-pill">${formatDate(dt)}</div>
            <div class="title">${escapeHTML(it.title)}</div>
            <div class="meta">${escapeHTML(it.cls || '')}</div>
          </div>
          ${it.notes ? `<div class="note">${escapeHTML(it.notes)}</div>` : ``}
        </div>`;
      listWrap.appendChild(li);
    });
  }

  // UI
  document.getElementById('toggle-upcoming').addEventListener('click', ()=>{ show='upcoming'; document.getElementById('toggle-upcoming').setAttribute('aria-pressed','true'); document.getElementById('toggle-past').setAttribute('aria-pressed','false'); draw(); });
  document.getElementById('toggle-past').addEventListener('click', ()=>{ show='past'; document.getElementById('toggle-past').setAttribute('aria-pressed','true'); document.getElementById('toggle-upcoming').setAttribute('aria-pressed','false'); draw(); });
  document.getElementById('search').addEventListener('input', ()=>{ searchText = document.getElementById('search').value.trim(); draw(); });
})();
</script>
</body>
</html>
