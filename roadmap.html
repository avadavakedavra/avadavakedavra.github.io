<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sehr Academy — Student Dashboard</title>
  <meta name="theme-color" content="#8BC53F" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800;900&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --primary:#8BC53F; --ink:#0f172a; --muted:#6b7280; --bg:#edf3e7;
      --border:#e6e8ec; --shadow:0 16px 44px rgba(15,23,42,.08);
      --r:16px; --r2:20px; --maxw:1180px;
      --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626; --info:#2563eb;
    }
    *{box-sizing:border-box} html,body{margin:0;padding:0}
    body{
      font-family:Nunito,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--ink); background:var(--bg);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      background-image:
        radial-gradient(900px 400px at -10% -10%, rgba(139,197,63,.08), transparent 60%),
        radial-gradient(900px 400px at 110% 0%, rgba(139,197,63,.06), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,0));
      background-attachment: fixed, fixed, fixed;
    }

    header#site-header{
      position:sticky;top:0;z-index:40;background:rgba(255,255,255,.78);
      border-bottom:1px solid rgba(230,232,236,.6);
      backdrop-filter:saturate(175%) blur(10px)
    }

    main{padding:40px 0}
    .container{max-width:var(--maxw);margin:0 auto;padding:0 20px}
    h1,h2,h3{font-family:Montserrat;margin:0}
    h1{font-size:32px}
    h2{font-size:22px}
    .muted{color:var(--muted);font-weight:700}

    /* Frosted cards */
    .card{
      background:linear-gradient(180deg,rgba(255,255,255,.68),rgba(255,255,255,.36));
      border:1px solid rgba(255,255,255,.55);
      border-radius:var(--r2);
      box-shadow:var(--shadow), inset 0 1px 0 rgba(255,255,255,.35);
      backdrop-filter: blur(12px) saturate(150%); -webkit-backdrop-filter: blur(12px) saturate(150%);
      padding:18px;
    }
    .grid{display:grid;gap:14px}
    @media(min-width:980px){ .grid.cols-3{grid-template-columns:2fr 1fr 1fr} }
    @media(min-width:980px){ .grid.cols-2{grid-template-columns:1.4fr 1fr} }

    /* -------- Glossy white glass buttons (NO ARROWS) -------- */
    .links{
      display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:12px
    }
    @media(min-width:720px){ .links{grid-template-columns:repeat(3,minmax(0,1fr))} }
    @media(min-width:1080px){ .links{grid-template-columns:repeat(4,minmax(0,1fr))} }
    .link{
      position:relative;
      display:flex;align-items:center;justify-content:center;text-align:center;
      padding:14px 16px;border-radius:18px;font-family:Montserrat;font-weight:900;font-size:15px;
      color:#0b0f10;text-decoration:none; user-select:none;
      background:linear-gradient(180deg,#fff 0%,#fcfcfc 55%,#f6f8f4 100%);
      border:1px solid rgba(0,0,0,.06);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.85),
        inset 0 -1px 0 rgba(255,255,255,.6),
        0 10px 26px rgba(15,23,42,.10);
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
      overflow:hidden;
    }
    .link::after{content:"";position:absolute;left:0;right:0;top:0;height:42%;
      background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,0))}
    .link:hover{transform:translateY(-1px);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.9), inset 0 -1px 0 rgba(255,255,255,.7), 0 14px 30px rgba(15,23,42,.14);
      border-color:rgba(139,197,63,.25)}
    .link:active{ transform: translateY(0) scale(.99) }

    /* Generic lists */
    .list{display:grid;gap:10px;margin-top:12px}
    .item{
      background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:12px 12px;
      box-shadow:0 10px 26px rgba(15,23,42,.08);display:grid;gap:6px
    }

    /* === Alignment polish for Next Class / Exams === */
    .item .top{
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center; /* vertical alignment fix */
      gap:12px;
      min-height:28px; /* consistent row height */
    }
    .item .title{
      font-weight:900; font-family:Montserrat; line-height:1.2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .item .right{display:flex;align-items:center;gap:8px}
    .meta{
      color:var(--muted);font-weight:700;font-size:13px;line-height:1.35;
      display:flex;align-items:center;gap:8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.06);background:#fff;font-weight:900;font-size:12px
    }
    .empty{padding:14px;text-align:center;border:1px dashed #d8dee8;border-radius:12px;background:#fff;color:#6b7280;font-weight:900}

    .row{display:grid;gap:10px}
    @media(min-width:760px){ .row.two{grid-template-columns:1fr 1fr} }
    select,button{
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;font-weight:800
    }
    .btn{cursor:pointer}
    .note{font-size:12px;color:#6b7280}
    .mt{margin-top:16px}

    /* Progress bar */
    .bar{height:12px;border-radius:999px;background:#e9ece7;position:relative;overflow:hidden;border:1px solid #eef2ea;margin-top:8px}
    .bar i{position:absolute;inset:0;background:linear-gradient(90deg,#f3df95,#e7c35c);box-shadow:inset 0 1px 0 rgba(255,255,255,.6)}

    /* === Filters (Year / Batch / Class) === */
    .filters{display:grid;gap:10px;margin-top:10px}
    @media(min-width:860px){ .filters{grid-template-columns:1fr 1fr 1fr} }
    .filters select{
      background:linear-gradient(180deg, #ffffff, #f7f9f6);
      border:1px solid rgba(0,0,0,.06);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.85), 0 8px 16px rgba(15,23,42,.06);
      font-weight:900;border-radius:14px
    }

    /* === Custom Student Dropdown with Avatars (mirrors studentlogin UX, but visual custom) === */
    .student-picker{position:relative}
    .sp-trigger{
      width:100%; display:flex; align-items:center; gap:10px; justify-content:space-between;
      padding:10px 12px; border-radius:14px; border:1px solid rgba(0,0,0,.06); background:#fff;
      font-weight:900; cursor:pointer; box-shadow:0 8px 16px rgba(15,23,42,.06), inset 0 1px 0 rgba(255,255,255,.85);
    }
    .sp-trigger .left{display:flex;align-items:center;gap:10px;min-width:0}
    .sp-trigger img{width:26px;height:26px;border-radius:999px;object-fit:cover;border:1px solid #eee}
    .sp-trigger .label{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .sp-trigger .caret{margin-left:auto;opacity:.6}
    .sp-menu{
      position:absolute; z-index:50; left:0; right:0; top:calc(100% + 6px);
      background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:14px;
      box-shadow:0 18px 40px rgba(15,23,42,.14);
      max-height:280px; overflow:auto; padding:6px; display:none;
    }
    .sp-menu.open{display:block}
    .sp-option{
      display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:10px; cursor:pointer;
    }
    .sp-option:hover{background:#f5f7f4}
    .sp-option img{width:28px;height:28px;border-radius:999px;object-fit:cover;border:1px solid #eee}
    .sp-empty{padding:10px;text-align:center;color:#6b7280;font-weight:800}
    .sp-option:focus{outline:2px solid var(--primary); outline-offset:2px}
  </style>
</head>
<body>
  <header id="site-header"></header>
  <script defer src="/assets/nav.js"></script>

  <main>
    <div class="container grid cols-3">
      <!-- Left / Welcome + Quick Links -->
      <section class="card">
        <h1>Student Dashboard</h1>
        <div class="muted mt">Everything you need — profiles, classes, exams, downloads — in one place.</div>

        <!-- Quick Links -->
        <div class="links">
          <a class="link" href="/studentlogin.html">Student Login</a>
          <a class="link" href="/student.html">Profiles</a>
          <a class="link" href="/syllabus.html">Syllabus Tracker</a>
          <a class="link" href="/calendar11.html">Calendar View</a>
          <a class="link" href="/schedule.html">Daily Schedule</a>
          <a class="link" href="/downloads.html">Downloads Library</a>
          <a class="link" href="/roadmap.html">Roadmap (Sessions)</a>
          <a class="link" href="/batchorigin.html">Class 11 — Origin</a>
        </div>

        <!-- Pick Student (filters like studentlogin + avatar dropdown) -->
        <div class="mt">
          <h2>Open My Profile</h2>

          <div class="filters" aria-label="Filter students">
            <select id="yearFilter" aria-label="Filter by year"><option value="">Year — All</option></select>
            <select id="batchFilter" aria-label="Filter by batch"><option value="">Batch — All</option></select>
            <select id="classFilter" aria-label="Filter by class"><option value="">Class — All</option></select>
          </div>

          <div class="row two mt">
            <div class="student-picker" id="studentPicker">
              <button class="sp-trigger" id="spTrigger" type="button" aria-haspopup="listbox" aria-expanded="false">
                <span class="left">
                  <img id="spAvatar" src="https://i.postimg.cc/0yD2YhRZ/user.png" alt="" />
                  <span class="label" id="spLabel">Select student…</span>
                </span>
                <span class="caret">▾</span>
              </button>
              <div class="sp-menu" id="spMenu" role="listbox" tabindex="-1" aria-label="Students"></div>
            </div>

            <button id="openProfile" class="btn">Open Profile</button>
          </div>
          <div class="note mt">Filters: Year → Batch → Class (from <code>/data/students.json</code>), then choose a student. Opens <code>student.url</code> or <code>/student.html?id=slug</code>.</div>
        </div>
      </section>

      <!-- Middle / Next Class + Exams -->
      <section class="card">
        <h2>Next Class</h2>
        <div id="nextClass" class="list mt">
          <div class="empty">Loading next class…</div>
        </div>

        <h2 class="mt">Upcoming Exams</h2>
        <div id="upcomingExams" class="list">
          <div class="empty">Loading exams…</div>
        </div>
      </section>

      <!-- Right / Announcements -->
      <section class="card">
        <h2>Announcements</h2>
        <div id="annList" class="list mt">
          <div class="empty">Fetching announcements…</div>
        </div>
      </section>
    </div>

    <!-- Subject Completion -->
    <div class="container mt">
      <section class="card">
        <h2>Subject Completion</h2>
        <div id="subjBars" class="grid" style="grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:10px"></div>
        <div class="note mt">Estimated % from <code>/data/syllabus.json</code> vs <code>/data/academic-2025-2026.json</code>.</div>
      </section>
    </div>
  </main>

  <script>
    /* ===== Utils ===== */
    const tryJSON = async (paths) => {
      for (const p of paths) {
        try { const r = await fetch(p, {cache:'no-cache'}); if (r.ok) return await r.json(); } catch {}
      }
      return null;
    };
    const safeArr = v => Array.isArray(v) ? v : [];
    const norm = s => (s||'').toString().toLowerCase().replace(/\s+/g,' ').trim();
    const baseTopic = t => (t||'').replace(/\s*[-–—]?\s*part\s*\d+.*$/i,'').trim();
    const partNum = t => { const m = (t||'').match(/part\s*(\d+)/i); return m ? +m[1] : 1; };
    const tidyTime = t => (t||'').replace(/\b0?(\d)\b/,'$1');
    const fmtDate = iso => { const d = new Date(iso); return isNaN(+d) ? (iso||'') : d.toLocaleDateString(undefined, { day:'2-digit', month:'short', year:'numeric' }); };
    const dayOf = iso => { const d = new Date(iso); return isNaN(+d) ? '' : d.toLocaleDateString(undefined, { weekday:'short' }); };
    const today = () => new Date().toISOString().slice(0,10);
    const escapeHtml = str => String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    /* ===== State ===== */
    let students = [];
    let announcements = [];
    let events = [];       // academic events
    let schedule = [];     // schedule.json
    let syllabusMap = {};  // subject -> chapters[]

    // Student picker state
    let selectedStudent = null;
    let currentFiltered = [];

    /* ===== Load all ===== */
    (async function(){
      const studentsJson = await tryJSON(['/data/students.json']); // ← exact path requested
      const annJson = await tryJSON(['/data/announcements.json','/announcements.json']);
      const academicJson = await tryJSON(['/data/academic-2025-2026.json']);
      const scheduleJson = await tryJSON(['/data/schedule.json','/schedule.json']);
      const syllabusJson = await tryJSON(['/data/syllabus.json']);

      students = safeArr(studentsJson);
      announcements = safeArr(annJson);
      events = safeArr(academicJson?.events);
      schedule = safeArr(scheduleJson);

      // Normalize syllabus (accept multiple shapes)
      if (Array.isArray(syllabusJson?.subjects)) {
        syllabusJson.subjects.forEach(s => { if(s?.name) syllabusMap[s.name] = safeArr(s.chapters || s.items || s.list); });
      } else if (syllabusJson?.subjects && typeof syllabusJson.subjects === 'object') {
        Object.keys(syllabusJson.subjects).forEach(k => { syllabusMap[k] = safeArr(syllabusJson.subjects[k]); });
      } else if (syllabusJson) {
        Object.keys(syllabusJson).forEach(k => { if (Array.isArray(syllabusJson[k])) syllabusMap[k] = syllabusJson[k]; });
      }

      initFiltersFromStudents();   // mirrors studentlogin filters
      rebuildStudentMenu();        // initial render of avatar dropdown

      buildNextClass();
      buildExams();
      buildAnnouncements();
      buildSubjectBars();

      wireOpenProfile();
      wirePickerUI();
    })();

    /* ===== Filters (mirror studentlogin.html logic) ===== */
    function uniq(arr){ return Array.from(new Set(arr.filter(v => v !== undefined && v !== null && String(v).trim() !== ''))); }
    function val(el){ return (el?.value || '').trim(); }

    function initFiltersFromStudents(){
      // These keys mirror typical studentlogin usage: year, batch, className
      const years = uniq(students.map(s => s.year || s.meta?.year));
      const batches = uniq(students.map(s => s.batch || s.meta?.batch));
      const classes = uniq(students.map(s => s.className || s.meta?.className));

      fillSelect('yearFilter', years, 'Year — All');
      fillSelect('batchFilter', batches, 'Batch — All');
      fillSelect('classFilter', classes, 'Class — All');

      // Cascade-like behaviour (choose year narrows batches/classes, etc.)
      ['yearFilter','batchFilter','classFilter'].forEach(id=>{
        document.getElementById(id).addEventListener('change', ()=>{
          // Recompute options based on current chosen filters (like studentlogin)
          const yf = val(document.getElementById('yearFilter'));
          const bf = val(document.getElementById('batchFilter'));

          const filteredForOpts = students.filter(s=>{
            const y = (s.year || s.meta?.year || '').toString();
            const b = (s.batch || s.meta?.batch || '').toString();
            return (!yf || y===yf) && (!bf || b===bf);
          });

          const nextBatches = uniq(filteredForOpts.map(s => s.batch || s.meta?.batch));
          const nextClasses = uniq(filteredForOpts.map(s => s.className || s.meta?.className));

          // Only repopulate the selects that are "downstream" of current change to mimic the UX
          if(id === 'yearFilter'){
            fillSelect('batchFilter', nextBatches, 'Batch — All');
            fillSelect('classFilter', nextClasses, 'Class — All');
          }
          if(id === 'batchFilter'){
            fillSelect('classFilter', nextClasses, 'Class — All');
          }

          rebuildStudentMenu();
        });
      });
    }

    function fillSelect(id, values, label){
      const sel = document.getElementById(id);
      const opts = ['<option value="">' + label + '</option>']
        .concat(values.map(v => `<option value="${String(v)}">${String(v)}</option>`));
      sel.innerHTML = opts.join('');
    }

    function applyFilters(){
      const yf = val(document.getElementById('yearFilter'));
      const bf = val(document.getElementById('batchFilter'));
      const cf = val(document.getElementById('classFilter'));
      return students.filter(s=>{
        const y = (s.year || s.meta?.year || '').toString();
        const b = (s.batch || s.meta?.batch || '').toString();
        const c = (s.className || s.meta?.className || '').toString();
        return (!yf || y===yf) && (!bf || b===bf) && (!cf || c===cf);
      }).sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    }

    /* ===== Custom Student Dropdown (with avatars) ===== */
    function rebuildStudentMenu(){
      currentFiltered = applyFilters();
      const menu = document.getElementById('spMenu');
      if(!currentFiltered.length){
        menu.innerHTML = `<div class="sp-empty">No students match these filters.</div>`;
      } else {
        menu.innerHTML = currentFiltered.map((s, i)=> renderOption(s, i)).join('');
      }
      selectedStudent = null;
      document.getElementById('spLabel').textContent = 'Select student…';
      document.getElementById('spAvatar').src = 'https://i.postimg.cc/0yD2YhRZ/user.png';
      attachOptionHandlers();
    }

    function renderOption(s, i){
      const name = s.name || 'Unnamed';
      const cls = s.className || s.meta?.className || '';
      const avatar = s.avatar || s.meta?.avatar || 'https://i.postimg.cc/0yD2YhRZ/user.png';
      const slug = s.slug || (name.toLowerCase().replace(/\s+/g,'-'));
      const url = s.url || (`/student.html?id=${encodeURIComponent(slug)}`);
      return `
        <div class="sp-option" role="option" tabindex="0"
             data-index="${i}"
             data-name="${escapeHtml(name)}"
             data-class="${escapeHtml(cls)}"
             data-avatar="${escapeHtml(avatar)}"
             data-url="${escapeHtml(url)}">
          <img src="${avatar}" alt="" />
          <div style="display:flex;flex-direction:column;min-width:0">
            <b style="font-family:Montserrat;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${name}</b>
            <span class="meta" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${cls}</span>
          </div>
        </div>`;
    }

    function attachOptionHandlers(){
      document.querySelectorAll('.sp-option').forEach(el=>{
        el.addEventListener('click', ()=> chooseOption(el));
        el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); chooseOption(el);} });
      });
    }

    function chooseOption(el){
      const name = el.getAttribute('data-name');
      const avatar = el.getAttribute('data-avatar');
      const url = el.getAttribute('data-url');
      selectedStudent = { name, avatar, url };
      document.getElementById('spLabel').textContent = name;
      document.getElementById('spAvatar').src = avatar;
      toggleMenu(false);
    }

    function wirePickerUI(){
      const trigger = document.getElementById('spTrigger');
      const menu = document.getElementById('spMenu');

      function onDocClick(e){
        if(!document.getElementById('studentPicker').contains(e.target)) toggleMenu(false);
      }

      window.toggleMenu = function(open){
        trigger.setAttribute('aria-expanded', open?'true':'false');
        menu.classList.toggle('open', !!open);
        if(open){ document.addEventListener('click', onDocClick); }
        else { document.removeEventListener('click', onDocClick); }
      }

      trigger.addEventListener('click', ()=> toggleMenu(!menu.classList.contains('open')));
      trigger.addEventListener('keydown', (e)=>{ if(e.key==='ArrowDown'){ e.preventDefault(); toggleMenu(true); const first = menu.querySelector('.sp-option'); first && first.focus(); }});
    }

    function wireOpenProfile(){
      document.getElementById('openProfile').addEventListener('click', ()=>{
        if(selectedStudent?.url){
          location.href = selectedStudent.url;
        } else if(currentFiltered.length === 1){
          const s = currentFiltered[0];
          const slug = s.slug || (s.name||'').toLowerCase().replace(/\s+/g,'-');
          const url = s.url || (`/student.html?id=${encodeURIComponent(slug)}`);
          location.href = url;
        } else {
          alert('Please select a student.');
        }
      });
    }

    /* ===== Next Class ===== */
    function buildNextClass(){
      const host = document.getElementById('nextClass');
      const t0 = today();
      const upcoming = (events||[])
        .filter(e => e.date && e.subject && e.topic && e.date >= t0 && !e.exam)
        .sort((a,b)=> a.date.localeCompare(b.date))
        .slice(0,3);

      if(!upcoming.length){
        host.innerHTML = `<div class="empty">No upcoming classes found.</div>`;
        return;
      }
      host.innerHTML = upcoming.map(e => `
        <div class="item">
          <div class="top">
            <div class="title">${escapeHtml(e.subject)}</div>
            <div class="right"><span class="pill">${fmtDate(e.date)} · ${dayOf(e.date)}</span></div>
          </div>
          <div class="meta">${tidyTime(e.time||'')} • <span title="${escapeHtml(e.topic||'')}">${escapeHtml(e.topic||'')}</span></div>
        </div>
      `).join('');
    }

    /* ===== Exams ===== */
    function buildExams(){
      const host = document.getElementById('upcomingExams');
      const t0 = today();

      const fromSchedule = (schedule||[])
        .filter(x => (x.title||'').toLowerCase().includes('qp') || (x.notes||'').toLowerCase().includes('test'))
        .map(x => ({date: (x.date||'').replace(/\/|\.|–/g,'-'), time:x.time, title:x.title, notes:x.notes}));

      const fromAcademic = (events||[])
        .filter(e => e.exam || (e.subject||'').toLowerCase()==='exam')
        .map(e => ({date:e.date, time:e.time, title:e.topic, notes:e.subject}));

      const all = [...fromSchedule, ...fromAcademic]
        .filter(x => x.date && x.date >= t0)
        .sort((a,b)=> a.date.localeCompare(b.date))
        .slice(0,4);

      if(!all.length){
        host.innerHTML = `<div class="empty">No upcoming exams.</div>`;
        return;
      }
      host.innerHTML = all.map(x=>`
        <div class="item">
          <div class="top">
            <div class="title">${escapeHtml(x.title || 'Exam')}</div>
            <div class="right"><span class="pill">${fmtDate(x.date)}</span></div>
          </div>
          <div class="meta">${tidyTime(x.time||'')} • <span title="${escapeHtml(x.notes||'')}">${escapeHtml(x.notes || '')}</span></div>
        </div>
      `).join('');
    }

    /* ===== Announcements ===== */
    function buildAnnouncements(){
      const host = document.getElementById('annList');
      if(!announcements.length){
        host.innerHTML = `<div class="empty">No announcements right now.</div>`;
        return;
      }
      const sorted = announcements.slice().sort((a,b)=> String(b.date||'').localeCompare(String(a.date||''))).slice(0,6);
      host.innerHTML = sorted.map(a=>{
        const url = a?.cta?.url || '#';
        const label = a?.cta?.label || 'Open';
        return `
          <div class="item">
            <div class="top">
              <div class="title">${escapeHtml(a.title || 'Announcement')}</div>
              <div class="right">${url && url!=='#' ? `<a class="pill" href="${url}">${escapeHtml(label)}</a>`:''}</div>
            </div>
            <div class="meta">${a.date ? fmtDate(a.date) : ''}</div>
          </div>
        `;
      }).join('');
    }

    /* ===== Subject completion ===== */
    function chapterTitle(obj){ return obj?.title || obj?.chapter || obj?.name || (typeof obj==='string' ? obj : ''); }

    function computePct(subject){
      const chaps = safeArr(syllabusMap[subject]);
      if(!chaps.length || !events.length) return 0;
      const subjectEvents = events.filter(e => (e.subject||'').trim() === subject);
      const stats = chaps.map(ch=>{
        const t = chapterTitle(ch);
        const tNorm = norm(t);
        const matches = subjectEvents.filter(e=>{
          const topic = e.topic || '';
          return norm(topic).includes(tNorm) || norm(baseTopic(topic)) === tNorm;
        });
        const partsDone = new Set(matches.map(m=>partNum(m.topic))).size || (matches.length?1:0);
        const totalParts = ch.parts || ch.totalParts || Math.max(partsDone, matches.length?1:0);
        const status = (ch.status||ch.state||'').toString().toLowerCase();
        const explicitDone = status==='done' || status==='completed' || ch.completed===true;
        const done = explicitDone || (totalParts>0 && partsDone >= totalParts);
        return {done};
      });
      const total = stats.length;
      const doneCount = stats.filter(x=>x.done).length;
      return Math.round(doneCount/Math.max(total,1)*100);
    }

    function buildSubjectBars(){
      const host = document.getElementById('subjBars');
      const subjects = Object.keys(syllabusMap);
      const order = ['Physics','Chemistry','Maths','Mathematics','Biology','Botany','Zoology'];
      const ordered = [...order.filter(s=>subjects.includes(s)), ...subjects.filter(s=>!order.includes(s))];

      host.innerHTML = ordered.map(s=>{
        const pct = computePct(s);
        return `
          <div class="item" style="padding:14px">
            <div class="top"><div class="title">${s}</div><div class="right"><span class="pill">${pct}%</span></div></div>
            <div class="bar"><i style="width:${pct}%"></i></div>
          </div>
        `;
      }).join('') || `<div class="empty">Add subjects to <code>/data/syllabus.json</code> to see progress here.</div>`;
    }
  </script>
</body>
</html>
