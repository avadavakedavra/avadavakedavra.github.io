<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sehr Academy — Syllabus Roadmap & Sessions</title>
  <meta name="theme-color" content="#8BC53F"/>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800;900&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --primary:#8BC53F; --ink:#0f172a; --muted:#6b7280;
      --bg:#edf3e7; --glass:linear-gradient(180deg,rgba(255,255,255,.68),rgba(255,255,255,.36));
      --border:#e6e8ec; --shadow:0 16px 44px rgba(15,23,42,.08);
      --maxw:1180px; --r:16px; --r2:20px;
      --gold:#e7c35c;
    }
    *{box-sizing:border-box}
    html,body{margin:0}
    body{
      font-family:Nunito,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--ink); background:var(--bg);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      background-image:
        radial-gradient(900px 400px at -10% -10%, rgba(139,197,63,.08), transparent 60%),
        radial-gradient(900px 400px at 110% 0%, rgba(139,197,63,.06), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,0));
      background-attachment: fixed, fixed, fixed;
    }

    header#site-header{
      position:sticky;top:0;z-index:40;background:rgba(255,255,255,.78);
      border-bottom:1px solid rgba(230,232,236,.6);
      backdrop-filter:saturate(175%) blur(10px)
    }
    main section{padding:54px 0}
    .container{max-width:var(--maxw);margin:0 auto;padding:0 20px}

    h1,h2,h3{font-family:"Montserrat",sans-serif;margin:0}
    h1{font-size:34px;line-height:1.15}
    h2{font-size:24px}
    h3{font-size:18px}

    .card{
      background:var(--glass);
      border:1px solid rgba(255,255,255,.55);
      border-radius:var(--r2);
      box-shadow:var(--shadow), inset 0 1px 0 rgba(255,255,255,.35);
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
      padding:18px;
    }
    .toolbar{display:grid;grid-template-columns:1fr 1.2fr;gap:18px;align-items:center}
    @media (max-width:960px){ .toolbar{grid-template-columns:1fr} }
    .subtitle{color:var(--muted);font-weight:700}

    .controls{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:10px}
    @media (max-width:960px){ .controls{grid-template-columns:1fr 1fr} }
    .sel,.search{display:flex;flex-direction:column;gap:8px;font-weight:800}
    label{font-family:Montserrat;font-size:12px;letter-spacing:.2px;color:#374151}
    select,input[type="search"]{
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;font-weight:800
    }

    /* Subject summary bars */
    .subject-grid{display:grid;gap:12px;margin-top:16px}
    @media(min-width:900px){.subject-grid{grid-template-columns:repeat(4,1fr)}}
    .subject{
      border-radius:16px;padding:14px;background:linear-gradient(180deg,#f8fbf2,#ffffff);
      border:1px solid rgba(255,255,255,.55); box-shadow:inset 0 1px 0 rgba(255,255,255,.6)
    }
    .subject .head{display:flex;align-items:center;justify-content:space-between}
    .subject .name{font-family:Montserrat;font-weight:900}
    .bar{height:12px;border-radius:999px;background:#e9ece7;position:relative;overflow:hidden;border:1px solid #eef2ea;margin-top:10px}
    .bar > i{position:absolute;inset:0;width:0;background:linear-gradient(90deg,#f3df95,#e7c35c);box-shadow:inset 0 1px 0 rgba(255,255,255,.6);transition:width .8s ease}

    /* Chapter details */
    .details-wrap{margin-top:18px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.6); background:linear-gradient(180deg,rgba(255,255,255,.92),rgba(255,255,255,.78));
      font-weight:900
    }
    .sessions{
      margin-top:12px; display:grid; gap:10px;
    }
    .sess{
      background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:12px;
      box-shadow:0 12px 26px rgba(15,23,42,.08);
      display:grid;gap:6px;
    }
    .sess .top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .sess .title{font-family:Montserrat;font-weight:900}
    .chip{font-family:Montserrat;font-weight:900;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(0,0,0,.08);background:#fff}
    .meta{color:var(--muted);font-weight:700}
    .empty{padding:16px;border-radius:14px;background:#fff;border:1px dashed #e2e8f0;text-align:center;font-weight:900;color:#6b7280;margin-top:10px}
    .error{padding:16px;border-radius:14px;background:#fff5f5;border:1px solid #fecaca;color:#b91c1c;margin-top:10px}
  </style>
</head>
<body>
  <header id="site-header"></header>
  <script src="/assets/nav.js" defer></script>

  <main>
    <section>
      <div class="container">
        <!-- Controls + subject summary -->
        <div class="card">
          <div class="toolbar">
            <div>
              <h1>Syllabus Roadmap</h1>
              <div class="subtitle">Pick a subject, then a chapter — or search by chapter name. Data from <code>/data/syllabus.json</code> and <code>/data/academic-2025-2026.json</code>.</div>
            </div>

            <div class="controls">
              <div class="sel">
                <label for="subject">Subject</label>
                <select id="subject" aria-label="Subject"></select>
              </div>
              <div class="sel">
                <label for="chapter">Chapter</label>
                <select id="chapter" aria-label="Chapter"></select>
              </div>
              <div class="search">
                <label for="q">Search chapter</label>
                <input id="q" type="search" placeholder="Type chapter name…"/>
              </div>
              <div class="sel">
                <label>&nbsp;</label>
                <button id="clear" style="padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;font-weight:900;cursor:pointer">Clear</button>
              </div>
            </div>
          </div>

          <!-- Subject progress summary -->
          <div id="subject-summary" class="subject-grid" aria-live="polite"></div>
        </div>

        <!-- Chapter details -->
        <div class="details-wrap">
          <div class="pill" id="summary-pill">Select a subject & chapter to view sessions.</div>
          <div id="sessions" class="sessions"></div>
          <div id="empty" class="empty" hidden>No matching sessions found.</div>
          <div id="error" class="error" hidden>Couldn’t load data (/data/syllabus.json or /data/academic-2025-2026.json).</div>
        </div>
      </div>
    </section>
  </main>

  <script>
    /* ===== Helpers ===== */
    const safeArray = v => Array.isArray(v) ? v : [];
    const norm = s => (s||'').toString().toLowerCase().replace(/\s+/g,' ').trim();
    const chapterTitle = obj => obj?.title || obj?.chapter || obj?.name || (typeof obj==='string' ? obj : '');
    const chapterPartsHint = obj => obj?.parts || obj?.totalParts || 0;
    const partNum = topic => { const m = (topic||'').match(/part\s*(\d+)/i); return m ? +m[1] : 1; };
    const fmtDate = iso => {
      const d = new Date(iso);
      if (isNaN(+d)) return iso || '';
      return d.toLocaleDateString(undefined, { weekday:'short', day:'2-digit', month:'short', year:'numeric' });
    };
    const tidyTime = t => (t||'').replace(/\b0?(\d)\b/,'$1'); // 06 -> 6

    /* ===== State ===== */
    let subjMap = {};            // { "Physics":[chapters], ... }
    let subjects = [];
    let eventsBySubject = {};    // { "Physics":[{date,time,subject,topic}], ... }
    let months = [];
    let academicMeta = {};

    /* ===== Load JSONs ===== */
    (async function init(){
      const errBox = document.getElementById('error');
      try{
        const [sylRes, acRes] = await Promise.all([
          fetch('/data/syllabus.json', {cache:'no-cache'}),
          fetch('/data/academic-2025-2026.json', {cache:'no-cache'})
        ]);
        if(!sylRes.ok || !acRes.ok) throw new Error('Fetch failed');

        const syllabus = await sylRes.json();
        const academic = await acRes.json();

        // Normalize syllabus
        if (Array.isArray(syllabus?.subjects)) {
          syllabus.subjects.forEach(s => { if(s?.name) subjMap[s.name] = safeArray(s.chapters || s.items || s.list); });
        } else if (syllabus?.subjects && typeof syllabus.subjects === 'object') {
          Object.keys(syllabus.subjects).forEach(k => { subjMap[k] = safeArray(syllabus.subjects[k]); });
        } else {
          Object.keys(syllabus||{}).forEach(k => { if (Array.isArray(syllabus[k])) subjMap[k] = syllabus[k]; });
        }
        subjects = Object.keys(subjMap);
        if (!subjects.length) throw new Error('No subjects in syllabus.json');

        // Academic events, grouped by subject
        academicMeta = academic?.meta || {};
        const ev = safeArray(academic?.events);
        months = Array.from(new Set(ev.map(e => (e.date||'').slice(0,7)).filter(Boolean))).sort();
        eventsBySubject = {};
        ev.forEach(e => {
          const s = (e.subject||'').trim();
          if (!s) return;
          (eventsBySubject[s] ||= []).push(e);
        });

        buildUI();
      }catch(e){
        console.error(e);
        errBox.hidden = false;
      }
    })();

    /* ===== UI ===== */
    function buildUI(){
      const subjectSel = document.getElementById('subject');
      const chapterSel = document.getElementById('chapter');
      const q = document.getElementById('q');
      const clearBtn = document.getElementById('clear');

      // Order subjects nicely
      const preferred = ['Physics','Chemistry','Maths','Mathematics','Biology','Botany','Zoology'];
      const ordered = [...preferred.filter(s=>subjects.includes(s)), ...subjects.filter(s=>!preferred.includes(s))];
      subjectSel.innerHTML = ordered.map(s=>`<option value="${s}">${s}</option>`).join('');
      // Populate chapter dropdown for the first subject
      populateChapters(subjectSel.value);

      // Render subject progress bars
      renderSubjectSummary();

      // Wire events
      subjectSel.addEventListener('change', ()=>{
        populateChapters(subjectSel.value);
        document.getElementById('q').value = '';
        renderChapterDetails(subjectSel.value, chapterSel.value, '');
      });
      chapterSel.addEventListener('change', ()=>{
        renderChapterDetails(subjectSel.value, chapterSel.value, q.value);
      });
      q.addEventListener('input', ()=>{
        // Try to auto-select chapter if search matches
        const list = subjMap[subjectSel.value] || [];
        const hit = list.find(ch => norm(chapterTitle(ch)).includes(norm(q.value)));
        if (hit){
          chapterSel.value = chapterTitle(hit);
        }
        renderChapterDetails(subjectSel.value, chapterSel.value, q.value);
      });
      clearBtn.addEventListener('click', ()=>{
        q.value=''; subjectSel.selectedIndex=0; populateChapters(subjectSel.value);
        renderChapterDetails(subjectSel.value, chapterSel.value, '');
      });

      // Initial details
      renderChapterDetails(subjectSel.value, chapterSel.value, q.value);
    }

    function populateChapters(subject){
      const chapterSel = document.getElementById('chapter');
      const list = subjMap[subject] || [];
      chapterSel.innerHTML = list.map(ch => {
        const t = chapterTitle(ch);
        return `<option value="${t}">${t}</option>`;
      }).join('');
    }

    /* ===== Progress bars (subject-wise) ===== */
    function computeSubjectProgress(subject){
      const chapters = safeArray(subjMap[subject]);
      const ev = eventsBySubject[subject] || [];

      const chapStates = chapters.map(ch=>{
        const title = chapterTitle(ch);
        const tNorm = norm(title);
        const matches = ev.filter(e => norm(e.topic||'').includes(tNorm)); // contains
        const explicitTotal = chapterPartsHint(ch);
        const observedParts = new Set(matches.map(m=>partNum(m.topic||'')));
        const inferredTotal = Math.max(explicitTotal, observedParts.size || (matches.length ? 1 : 0), explicitTotal ? 1 : 0);
        const partsDone = observedParts.size || (matches.length ? 1 : 0);

        // If user marks status in syllabus.json, respect it; else infer by parts
        const s = norm(ch?.status || ch?.state || '');
        const explicitDone = (s==='done' || s==='completed' || ch?.completed===true);
        const done = explicitDone ? true : (inferredTotal>0 && partsDone >= inferredTotal);

        return { done };
      });

      const total = chapStates.length || 1;
      const doneCount = chapStates.filter(c=>c.done).length;
      const pct = Math.round(doneCount/total*100);
      return pct;
    }

    function renderSubjectSummary(){
      const host = document.getElementById('subject-summary');
      host.innerHTML = '';
      const frag = document.createDocumentFragment();
      subjects.forEach(subj=>{
        const pct = computeSubjectProgress(subj);
        const card = document.createElement('div');
        card.className = 'subject';
        card.innerHTML = `
          <div class="head">
            <div class="name">${subj}</div>
            <div class="pct">${pct}%</div>
          </div>
          <div class="bar"><i style="width:${pct}%"></i></div>
        `;
        frag.appendChild(card);
      });
      host.appendChild(frag);
    }

    /* ===== Chapter details renderer ===== */
    function renderChapterDetails(subject, chapterTitleStr, searchStr){
      const pill = document.getElementById('summary-pill');
      const sessionsHost = document.getElementById('sessions');
      const empty = document.getElementById('empty');
      sessionsHost.innerHTML = ''; empty.hidden = true;

      if(!subject){
        pill.textContent = 'Select a subject & chapter to view sessions.'; return;
      }
      const events = eventsBySubject[subject] || [];

      // If a search is given, prefer it; else use selected chapter
      const qn = norm(searchStr||'');
      const chapterKey = qn || norm(chapterTitleStr||'');
      if(!chapterKey){ pill.textContent = `Select a chapter in ${subject}.`; return; }

      // Find all events where TOPIC includes the chapterKey
      const matched = events.filter(e => norm(e.topic||'').includes(chapterKey));

      // Group by Part number (default 1 if not found)
      const partsMap = new Map(); // part -> array of events (keep earliest as expected)
      matched.forEach(e=>{
        const p = partNum(e.topic||'');
        if(!partsMap.has(p)) partsMap.set(p, []);
        partsMap.get(p).push(e);
      });

      // Summary pill text
      const partsCount = partsMap.size || (matched.length?1:0);
      const niceChapterName = chapterTitleStr || (matched[0]?.topic?.split(' Part ')[0] || '');
      pill.textContent = niceChapterName
        ? `${subject} · ${niceChapterName} · ${partsCount || 0} part(s)`
        : `${subject} · ${partsCount || 0} part(s)`;

      if (!matched.length){
        empty.hidden = false;
        return;
      }

      // Build session cards in increasing Part order
      const parts = Array.from(partsMap.keys()).sort((a,b)=>a-b);
      const frag = document.createDocumentFragment();
      parts.forEach(p=>{
        // Choose earliest event for this Part as the expected start
        const list = partsMap.get(p).slice().sort((a,b)=>(a.date>b.date?1:-1));
        const e0 = list[0];
        const el = document.createElement('div');
        el.className = 'sess';
        el.innerHTML = `
          <div class="top">
            <div class="title">Part ${p}</div>
            <span class="chip">Expected</span>
          </div>
          <div class="meta"><b>Date:</b> ${fmtDate(e0.date)}</div>
          <div class="meta"><b>Time:</b> ${tidyTime(e0.time || '')}</div>
          <div class="meta"><b>Day:</b> ${fmtDate(e0.date).split(',')[0]}</div>
          <div class="meta"><b>Topic:</b> ${e0.topic || ''}</div>
        `;
        frag.appendChild(el);
      });
      sessionsHost.appendChild(frag);
    }
  </script>
</body>
</html>
