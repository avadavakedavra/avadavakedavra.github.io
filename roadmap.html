<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sehr Academy — Student Dashboard</title>
  <meta name="theme-color" content="#8BC53F" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800;900&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --primary:#8BC53F; --ink:#0f172a; --muted:#6b7280; --bg:#edf3e7;
      --glass:linear-gradient(180deg,rgba(255,255,255,.68),rgba(255,255,255,.36));
      --border:#e6e8ec; --shadow:0 16px 44px rgba(15,23,42,.08);
      --r:16px; --r2:20px; --maxw:1180px;
      --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626; --info:#2563eb;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family:Nunito,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--ink); background:var(--bg);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      background-image:
        radial-gradient(900px 400px at -10% -10%, rgba(139,197,63,.08), transparent 60%),
        radial-gradient(900px 400px at 110% 0%, rgba(139,197,63,.06), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,0));
      background-attachment: fixed, fixed, fixed;
    }

    header#site-header{
      position:sticky;top:0;z-index:40;background:rgba(255,255,255,.78);
      border-bottom:1px solid rgba(230,232,236,.6);
      backdrop-filter:saturate(175%) blur(10px)
    }

    main{padding:40px 0}
    .container{max-width:var(--maxw);margin:0 auto;padding:0 20px}
    h1,h2,h3{font-family:Montserrat;margin:0}
    h1{font-size:32px}
    h2{font-size:22px}
    .muted{color:var(--muted);font-weight:700}

    /* Cards */
    .card{
      background:var(--glass);
      border:1px solid rgba(255,255,255,.55);
      border-radius:var(--r2);
      box-shadow:var(--shadow), inset 0 1px 0 rgba(255,255,255,.35);
      backdrop-filter: blur(12px) saturate(150%); -webkit-backdrop-filter: blur(12px) saturate(150%);
      padding:18px;
    }
    .grid{display:grid;gap:14px}
    @media(min-width:980px){ .grid.cols-3{grid-template-columns:2fr 1fr 1fr} }
    @media(min-width:980px){ .grid.cols-2{grid-template-columns:1.4fr 1fr} }

    /* Quick links */
    .links{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:12px}
    @media(min-width:720px){ .links{grid-template-columns:repeat(3,minmax(0,1fr))} }
    @media(min-width:1080px){ .links{grid-template-columns:repeat(4,minmax(0,1fr))} }
    .link{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:12px 12px;
      text-decoration:none;color:#0b0f10;font-weight:900;font-family:Montserrat;
      box-shadow:0 10px 26px rgba(15,23,42,.08);
    }
    .link:hover{outline:2px solid #e7f3db}

    /* Mini stat */
    .stat{display:grid;gap:8px}
    .stat .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.06);background:#fff;font-weight:900}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .info{color:var(--info)}

    /* Lists */
    .list{display:grid;gap:10px;margin-top:12px}
    .item{
      background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:10px 12px;
      box-shadow:0 10px 26px rgba(15,23,42,.08);
      display:grid;gap:4px
    }
    .item .top{display:flex;align-items:center;justify-content:space-between}
    .meta{color:var(--muted);font-weight:700;font-size:12px}
    .empty{padding:14px;text-align:center;border:1px dashed #d8dee8;border-radius:12px;background:#fff;color:#6b7280;font-weight:900}

    /* Profile pick */
    .row{display:grid;gap:10px}
    @media(min-width:760px){ .row.two{grid-template-columns:1fr 1fr} }
    select,input[type="search"],button{
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;font-weight:800
    }
    .btn{cursor:pointer}
    .note{font-size:12px;color:#6b7280}

    /* Footer space */
    .mt{margin-top:16px}
  </style>
</head>
<body>
  <header id="site-header"></header>
  <script defer src="/assets/nav.js"></script>

  <main>
    <div class="container grid cols-3">
      <!-- Left / Welcome + Quick Links -->
      <section class="card">
        <h1>Student Dashboard</h1>
        <div class="muted mt">Everything you need — profiles, classes, exams, downloads — in one place.</div>

        <!-- Quick Links -->
        <div class="links">
          <a class="link" href="/studentlogin.html">Student Login<span>→</span></a>
          <a class="link" href="/student.html">Profiles<span>→</span></a>
          <a class="link" href="/syllabus.html">Syllabus Tracker<span>→</span></a>
          <a class="link" href="/calendar11.html">Calendar View<span>→</span></a>
          <a class="link" href="/schedule.html">Daily Schedule<span>→</span></a>
          <a class="link" href="/downloads.html">Downloads Library<span>→</span></a>
          <a class="link" href="/roadmap.html">Roadmap (Sessions)<span>→</span></a>
          <a class="link" href="/batchorigin.html">Class 11 — Origin<span>→</span></a>
        </div>

        <!-- Pick Student (deep links) -->
        <div class="mt">
          <h2>Open My Profile</h2>
          <div class="row two mt">
            <select id="studentSelect" aria-label="Select student"></select>
            <button id="openProfile" class="btn">Open Profile</button>
          </div>
          <div class="note mt">Tip: this links to the dynamic profile page (e.g., <code>/student.html?id=fidha</code>).</div>
        </div>
      </section>

      <!-- Middle / Next Class + Exams -->
      <section class="card">
        <h2>Next Class</h2>
        <div id="nextClass" class="list mt">
          <div class="empty">Loading next class…</div>
        </div>

        <h2 class="mt">Upcoming Exams</h2>
        <div id="upcomingExams" class="list">
          <div class="empty">Loading exams…</div>
        </div>
      </section>

      <!-- Right / Announcements -->
      <section class="card">
        <h2>Announcements</h2>
        <div id="annList" class="list mt">
          <div class="empty">Fetching announcements…</div>
        </div>
      </section>
    </div>

    <!-- Subject Completion (from calendar vs syllabus) -->
    <div class="container mt">
      <section class="card">
        <h2>Subject Completion</h2>
        <div id="subjBars" class="grid" style="grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:10px"></div>
        <div class="note mt">Estimated % based on calendar coverage of chapters in <code>/data/syllabus.json</code>.</div>
      </section>
    </div>
  </main>

  <script>
    /* ===== Utils ===== */
    const tryJSON = async (paths) => {
      for (const p of paths) {
        try { const r = await fetch(p, {cache:'no-cache'}); if (r.ok) return await r.json(); } catch {}
      }
      return null;
    };
    const safeArr = v => Array.isArray(v) ? v : [];
    const norm = s => (s||'').toString().toLowerCase().replace(/\s+/g,' ').trim();
    const baseTopic = t => (t||'').replace(/\s*[-–—]?\s*part\s*\d+.*$/i,'').trim();
    const partNum = t => { const m = (t||'').match(/part\s*(\d+)/i); return m ? +m[1] : 1; };
    const tidyTime = t => (t||'').replace(/\b0?(\d)\b/,'$1'); // 06 -> 6
    const fmtDate = iso => {
      const d = new Date(iso);
      return isNaN(+d) ? (iso||'') : d.toLocaleDateString(undefined, { day:'2-digit', month:'short', year:'numeric' });
    };
    const dayOf = iso => {
      const d = new Date(iso);
      return isNaN(+d) ? '' : d.toLocaleDateString(undefined, { weekday:'short' });
    };
    const today = () => new Date().toISOString().slice(0,10);

    /* ===== State ===== */
    let students = [];
    let announcements = [];
    let events = [];       // from academic-2025-2026.json
    let schedule = [];     // from schedule.json
    let syllabusMap = {};  // subject -> chapters[]

    /* ===== Load all ===== */
    (async function(){
      // JSONs (with safe fallbacks)
      const studentsJson = await tryJSON(['/students.json']);
      const annJson = await tryJSON(['/data/announcements.json','/announcements.json']);
      const academicJson = await tryJSON(['/data/academic-2025-2026.json']);
      const scheduleJson = await tryJSON(['/data/schedule.json','/schedule.json']);
      const syllabusJson = await tryJSON(['/data/syllabus.json']);

      students = safeArr(studentsJson);
      announcements = safeArr(annJson);
      events = safeArr(academicJson?.events);
      schedule = safeArr(scheduleJson);

      // Normalize syllabus (accept multiple shapes)
      if (Array.isArray(syllabusJson?.subjects)) {
        syllabusJson.subjects.forEach(s => { if(s?.name) syllabusMap[s.name] = safeArr(s.chapters || s.items || s.list); });
      } else if (syllabusJson?.subjects && typeof syllabusJson.subjects === 'object') {
        Object.keys(syllabusJson.subjects).forEach(k => { syllabusMap[k] = safeArr(syllabusJson.subjects[k]); });
      } else if (syllabusJson) {
        Object.keys(syllabusJson).forEach(k => { if (Array.isArray(syllabusJson[k])) syllabusMap[k] = syllabusJson[k]; });
      }

      buildStudents();
      buildNextClass();
      buildExams();
      buildAnnouncements();
      buildSubjectBars();
    })();

    /* ===== Build: Students ===== */
    function buildStudents(){
      const sel = document.getElementById('studentSelect');
      sel.innerHTML = students.map(s => `<option value="${s.url || ('/student.html?id='+ (s.slug||''))}">${s.name} — ${s.className || ''}</option>`).join('');
      document.getElementById('openProfile').addEventListener('click', ()=>{
        const url = sel.value || '/student.html';
        location.href = url;
      });
    }

    /* ===== Build: Next Class from academic events ===== */
    function buildNextClass(){
      const host = document.getElementById('nextClass');
      const t0 = today();
      const upcoming = events
        .filter(e => e.date && e.subject && e.topic && e.date >= t0 && !e.exam)
        .sort((a,b)=> a.date.localeCompare(b.date))
        .slice(0,3);

      if(!upcoming.length){
        host.innerHTML = `<div class="empty">No upcoming classes found.</div>`;
        return;
      }
      host.innerHTML = upcoming.map(e => `
        <div class="item">
          <div class="top"><b>${e.subject}</b><span class="pill">${fmtDate(e.date)} · ${dayOf(e.date)}</span></div>
          <div class="meta">${tidyTime(e.time||'')} • ${e.topic||''}</div>
        </div>
      `).join('');
    }

    /* ===== Build: Exams (from schedule.json + academic exams) ===== */
    function buildExams(){
      const host = document.getElementById('upcomingExams');
      const t0 = today();

      const fromSchedule = schedule
        .filter(x => (x.title||'').toLowerCase().includes('qp') || (x.notes||'').toLowerCase().includes('test'))
        .map(x => ({date: (x.date||'').replace(/\/|\.|–/g,'-'), time:x.time, title:x.title, notes:x.notes}));

      const fromAcademic = events
        .filter(e => e.exam || (e.subject||'').toLowerCase()==='exam')
        .map(e => ({date:e.date, time:e.time, title:e.topic, notes:e.subject}));

      const all = [...fromSchedule, ...fromAcademic]
        .filter(x => x.date && x.date >= t0)
        .sort((a,b)=> a.date.localeCompare(b.date))
